---
layout: post
title: Java并发编程的艺术读后总结（一）
date: 2020-06-28
categories: 技术
tags: 并发编程
---

## 并发编程的挑战

### 上下文切换

CPU 通过时间片的分配算法来循环执行任务，当前任务执行一个时间片后会切换到下一个任务。在切换前会保存上一个任务的状态，以便下次切换回这个任务时，可以再加载这个任务的状态。这个**任务从保存到再加载的的过程就是一次上下文切换。**

### 如何减少上下文切换

减少上下文切换的方法有无锁并发编程、CAS 算法、使用最少线程和使用协程。

- **无锁并发编程**。对线程竞争锁时，会引起上下文切花，所以多线程处理数据时，可以用一些办法来避免使用锁，如果将数据的 ID 按照 Hash 算法取模分段，不同的线程处理不同段的数据。
- **CAS 算法**。Java 的 Atomic 包使用 CAS 算法来更新数据，而不需要加锁。
- **使用最少线程**。避免创建不需要的线程，比如任务很少，但是创建了很多线程来处理，这样就会造成大量线程都处于等待状态。
- **协程**：在单线程里实现多任务的调度，并在但县城里维持多个任务之间的切换。

### 死锁

锁是个非常有用的工具，运用场景非常多，使用简单且易于理解。但同时它也会带来一些困扰，那就是可能会引起死锁。

**避免死锁的常见方法：**

- 避免一个线程同时获取多个锁
- 避免一个线程在锁内同时占用多个资源，尽量保证每个锁只占用一个资源。
- 尝试使用定时锁，使用 lock.tryLock(timeout) 来代替使用内部锁机制。
- 对于数据库锁，加锁和解锁必须在一个数据库的连接里，否则会出现解锁失败的情况。

### 资源限制的挑战

资源限制是指在进行并发编程时，程序的执行速度受限于计算机硬件资源或软件资源。这时我们需要根据拨通的资源限制调整程序的并发力度。有数据库操作时，设计数据库连接数，如果 SQL 语句执行非常快，而线程的数量比数据库连接数大很多，则某些线程会被阻塞，等待数据库连接。