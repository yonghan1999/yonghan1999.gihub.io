---
layout: post
title: 浅谈 TCP 协议（二）
date: 2020-06-24
categories: 技术
tags: Network TCP
---

### TCP报文段的首部格式

TCP虽然是面向字节流的，但是TCP传送的数据单元却是报文段，而且TCP的**全部功能都体现在它的首部中各个字段**。

![TCP报文段首部.png](https://i.loli.net/2020/06/24/4W7VPM6ODxZQSUK.png)

**源端口和目的端口字段**——各占 2 字节。端口是运输层与应用层的服务接口。运输层的复用和分用功能都要通过端口才能实现。

**序号字段**——占 4 字节。TCP 连接中传送的数据流中的**每一个字节都编上一个序号**。序号字段的值则指的是本报文段所发送的数据的**第一个字节的序号**。

**确认号字段**——占 4 字节，是**期望收到对方的下一个报文段的数据的第一个字节的序号**。例如，B正确收到了A发送过来的一个报文段，其序号字段值是501，而数据长度是200字节（序号501 - 700），这表明B正确收到了A发送的到序号700为止的数据，因此，B期望收到A的下一个数据序号为701，于是B在发送给A的确认报文段中把确认号置位701。**总之，若确认号为N，则表明到N-1为止的所有数据都已正确收到**。

**数据偏移（即首部长度）**——占 4 位，它指出 TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远。“数据偏移”的单位是 32 位字（以 4 字节为计算单位）。

**保留字段**——占 6 位，保留为今后使用，但目前应置为 0

**紧急 URG** —— 当 URG  =  1 时，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送(相当于高优先级的数据)

**确认 ACK** —— 只有当 ACK = 1 时确认号字段才有效。当 ACK = 0 时，确认号无效。TCP规定，在建立连接后所有传送的报文段都必须把ACK置1

**推送 PSH (PuSH)** —— 接收 TCP 收到 PSH = 1 的报文段，就尽快地交付接收应用进程，而不再等到整个缓存都填满了后再向上交付。

**复位 RST (ReSeT)** —— 当 RST = 1 时，表明 TCP 连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接。

**同步 SYN** —— 在连接建立时用来同步序号，当SYN = 1而ACK = 0时，表明这是一个连接请求报文。对方若同意建立连接，则应在响应的报文段中使SYN = 1和ACK = 1。所以，SYN = 1 表示这是一个**连接请求或连接接受报文**。

**终止 FIN (FINis)** —— 用来释放一个连接。FIN = 1 表明此报文段的发送端的数据已发送完毕，并要求释放运输连接。

**窗口字段** —— 占 2 字节，窗口值是[0,2^16 -1]之间的整数。窗口指的是发送本报文段的一方的**接收窗口**（而不是自己的发送窗口）。窗口值**告诉对方**：从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。总之**窗口值作为接收方让发送方设置其发送窗口的依据。**例如。设确认号是701，窗口字段是1000.这就表明，从701号算起，发送此报文段的一方还有接收1000个字节数据（字节序号701-1700）的接收缓存空间。**总之，窗口字段指出了现在允许对方发送的数据量。窗口值是经常在动态变化着**

**检验和** —— 占 2 字节。检验和字段检验的范围包括首部和数据这两部分。**与UDP一样**在计算检验和时，要在 TCP 报文段的前面加上 12 字节的伪首部。

**紧急指针字段** —— 占 16 位，仅在URG = 1时才有意义，它指出在本报文段中紧急数据共有多少个字节（紧急数据放在本报文段数据的最前面，因此紧急指针指出了紧急数据的末尾在报文段中的位置）。

**选项字段** —— 长度可变。TCP 最初只规定了一种选项，即**最大报文段长度 MSS**。MSS 告诉对方 TCP：“我的缓存所能接收的报文段的数据字段的最大长度是 MSS 个字节。” **MSS (Maximum Segment Size)是 TCP 报文段中的数据字段的最大长度。数据字段加上 TCP 首部才等于整个的 TCP 报文段。**

**其他选项**

- 窗口扩大选项 ——占 3 字节，其中有一个字节表示移位值 S。新的窗口值等于TCP 首部中的窗口位数增大到(16 + S)，相当于把窗口值向左移动 S 位后获得实际的窗口大小。
- 时间戳选项——占10 字节，其中最主要的字段时间戳值字段（4 字节）和时间戳回送回答字段（4 字节）。
- 选择确认选项

**填充字段** —— 这是为了使整个首部长度是 **4 字节**的整数倍。