<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Han的小站">
    <meta name="description" content="Han的小站">
    <meta name="author" content="Han">
    
    <title>
        
            RFC3489（STUN），已过时 |
        
        Han的小站
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"hanblog.fun","root":"/","language":"zh-CN","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":false,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"https://image.hanblog.fun/images/2022/04/27/06cc54c40991403a3f17178a8a09fd9e.jpg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"一直写代码，直到看不清屏幕那一天"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":false,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Han的小站
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">RFC3489（STUN），已过时</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="https://image.hanblog.fun/images/2022/04/27/06cc54c40991403a3f17178a8a09fd9e.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Han</span>
                        
                            <span class="author-label">Lv5</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2025-01-01 00:00:00</span>
        <span class="mobile">2025-01-01 00:00</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E6%8A%80%E6%9C%AF/">技术</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/NAT-STUN/">NAT STUN</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p><strong>RFC3489（STUN）简介</strong></p>
<p>RFC3489（Session Traversal Utilities for NAT，早期称为 Simple Traversal of UDP Through NAT）是最初定义的 STUN 协议，用于帮助客户端在有 NAT（网络地址转换）或防火墙的网络环境中，探测自身在公网上所“呈现”出来的 IP 地址和端口，并推断出 NAT 的类型，从而实现点对点通信（尤其是 UDP 通信）的打洞与穿透。</p>
<p>自 RFC3489 发布后，IETF 又在其基础上进行了修订并发布了 RFC5389，定义了更为通用的 STUN（Session Traversal Utilities for NAT）。但如果我们关注的是 RFC3489 的检测流程，以下内容将对其做一个较为完整的介绍。</p>
<h3 id="RFC3489-检测流程概述"><a href="#RFC3489-检测流程概述" class="headerlink" title="RFC3489 检测流程概述"></a>RFC3489 检测流程概述</h3><p>RFC3489 规定了一个通过发送多个 STUN Binding Request 到 STUN 服务器（一般包含至少两个地址或端口）来判断 NAT 类型的流程。它主要基于以下假设：</p>
<ol>
<li><strong>服务器可同时在两个不同地址或端口上侦听</strong>（通常称为 <code>Server Reflexive Transport Address #1</code> 和 <code>Server Reflexive Transport Address #2</code>）。</li>
<li><strong>客户端可以根据 STUN 服务器返回的结果</strong>（Binding Response）来判断自己“看到”的外部 IP 地址及端口，以及基于对不同测试行为结果的分析，推断 NAT 的行为模式。</li>
</ol>
<blockquote>
<p><strong>注意</strong>：随着互联网的发展和 NAT 技术的多样化，RFC3489 中的 NAT 类型检测算法在实际环境中并不总是准确；后来才有了更完善的 RFC5389 &#x2F; ICE（Interactive Connectivity Establishment）等方案。不过理解 RFC3489 的经典检测流程，对于理解 NAT 和 STUN 依然有帮助。</p>
</blockquote>
<h3 id="关键概念"><a href="#关键概念" class="headerlink" title="关键概念"></a>关键概念</h3><ol>
<li><strong>Mapped Address</strong><br>客户端从 STUN 服务器收到的 <code>MAPPED-ADDRESS</code> 属性（在 Binding Response 中），表示服务器看到的源 IP 与端口，即“公网上”映射出的地址。</li>
<li><strong>Changed Address</strong><br>STUN 服务器在响应中可能会携带 <code>CHANGED-ADDRESS</code> 属性，用于指示另一个可用于测试的 STUN 服务器地址或端口（RFC3489 中常常是同一物理服务器上的另一个端口或 IP）。</li>
<li><strong>NAT 类型</strong><br>RFC3489 按照不同的 NAT 行为，将 NAT 分为以下几类：<ul>
<li><strong>Full Cone NAT</strong></li>
<li><strong>Restricted Cone NAT</strong></li>
<li><strong>Port Restricted Cone NAT</strong></li>
<li><strong>Symmetric NAT</strong><br>以及在无 NAT 的情况即“Open Internet”。</li>
</ul>
</li>
</ol>
<h3 id="RFC3489-检测流程详解"><a href="#RFC3489-检测流程详解" class="headerlink" title="RFC3489 检测流程详解"></a>RFC3489 检测流程详解</h3><p>下文给出了经典的 RFC3489 检测流程示例。实际使用中，客户端需要实现一个简单的“状态机”，根据不同测试步骤获得的结果来判断 NAT 类型。</p>
<h4 id="步骤-1-基础测试-I-（Test-I）"><a href="#步骤-1-基础测试-I-（Test-I）" class="headerlink" title="步骤 1: 基础测试 I （Test I）"></a>步骤 1: 基础测试 I （Test I）</h4><ol>
<li><p>客户端 → 服务器（IP1:PORT1）</p>
<ul>
<li>客户端向 STUN 服务器（第一个地址&#x2F;端口，记为 <code>IP1:PORT1</code>）发送一个 Binding Request，请求返回自身的外部映射地址。</li>
</ul>
</li>
<li><p>服务器响应</p>
<ul>
<li>服务器收到请求后，将客户端源地址作为 <code>MAPPED-ADDRESS</code> 写入 Binding Response 中。</li>
<li>同时在 Binding Response 中携带 <code>CHANGED-ADDRESS</code>，即服务器可用来进行后续测试的“备用地址&#x2F;端口” (<code>IP2:PORT2</code>)。</li>
</ul>
</li>
<li><p>客户端处理响应</p>
<ul>
<li><p>若客户端收到了正确的响应，则可以在返回的消息里读取 <code>MAPPED-ADDRESS</code>。假设该地址为 <code>MappedAddr1</code>。</p>
</li>
<li><p>判断 <code>MappedAddr1</code>与客户端自身的本地绑定地址是否相同：</p>
<ul>
<li>如果相同，说明客户端可能不在 NAT 后（或在一个 Full Cone NAT 中）。继续进行下一步测试以确认具体类型。</li>
<li>如果不同，说明客户端在 NAT 后，需要进一步测试确定 NAT 种类。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="步骤-2-基础测试-II-（Test-II）"><a href="#步骤-2-基础测试-II-（Test-II）" class="headerlink" title="步骤 2: 基础测试 II （Test II）"></a>步骤 2: 基础测试 II （Test II）</h4><ol>
<li>客户端 → 服务器（IP1:PORT1），但在请求中指定 <code>CHANGE-REQUEST</code><ul>
<li>客户端这次仍然向 <code>IP1:PORT1</code> 发送 Binding Request，但是在 STUN 消息的属性中带上 <code>CHANGE-REQUEST</code>，要求服务器使用与之前不同的地址和端口（即 <code>IP2:PORT2</code>）来发送响应。</li>
</ul>
</li>
<li>服务器行为<ul>
<li>如果服务器实现了 RFC3489，则会检查 <code>CHANGE-REQUEST</code> 属性，如果属性中指定要“Change IP 和 Change Port”，那么服务器就会从 <code>IP2:PORT2</code> 向客户端发送响应。</li>
</ul>
</li>
<li>客户端的结果判断<ul>
<li>如果客户端 <strong>能收到</strong> 服务器从 <code>IP2:PORT2</code> 发来的响应，则意味着客户端的 NAT 不会阻止来自不同地址和端口的 UDP 数据包通过。这通常表明客户端所在网络是 <strong>Open Internet 或 Full Cone NAT</strong>。</li>
<li>如果客户端 <strong>收不到</strong> 响应，则通常意味着客户端所在的 NAT 会阻止来自不同 IP&#x2F;端口的响应包，这一现象多与 <strong>Symmetric NAT</strong> 或者 <strong>(Port) Restricted Cone NAT</strong> 类型相匹配。为了区分，还需要下一步测试。</li>
</ul>
</li>
</ol>
<h4 id="步骤-3-备用地址测试（Test-III）"><a href="#步骤-3-备用地址测试（Test-III）" class="headerlink" title="步骤 3: 备用地址测试（Test III）"></a>步骤 3: 备用地址测试（Test III）</h4><ol>
<li>客户端 → 服务器（IP2:PORT2）<ul>
<li>这次，客户端直接向服务器的另一个地址和端口 <code>IP2:PORT2</code>（即 <code>CHANGED-ADDRESS</code>）发送 Binding Request。</li>
</ul>
</li>
<li>服务器响应<ul>
<li>服务器收到请求后，会返回客户端的 <code>MAPPED-ADDRESS</code>，记为 <code>MappedAddr2</code>。</li>
</ul>
</li>
<li>比较 <code>MappedAddr1</code> 与 <code>MappedAddr2</code><ul>
<li>如果 <code>MappedAddr1</code> 与 <code>MappedAddr2</code> 不同（即，分别是不同的外部端口或 IP），那么通常可以判定为 <strong>Symmetric NAT</strong>。因为 Symmetric NAT 的映射端口取决于目的地址&#x2F;端口，对不同目标地址时会出现不同的外部端口。</li>
<li>如果 <code>MappedAddr1</code> 与 <code>MappedAddr2</code> 相同，则说明 NAT 在面对不同的服务器地址时依旧使用同一个外部映射，即不是 Symmetric NAT。结合之前的结果，可以判断是 <strong>Restricted Cone NAT</strong> 或 <strong>Port Restricted Cone NAT</strong>。</li>
</ul>
</li>
</ol>
<h4 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h4><p><img src="https://image.hanblog.fun/images/2025/01/01/RFC3489.png" alt="img"></p>
<h3 id="常见结果与-NAT-类型判定"><a href="#常见结果与-NAT-类型判定" class="headerlink" title="常见结果与 NAT 类型判定"></a>常见结果与 NAT 类型判定</h3><p>以下是根据上述三个测试的可能结果，结合 RFC3489 给出的 NAT 类型划分示例：</p>
<ol>
<li><strong>Open Internet</strong><ul>
<li>在 Test I 中，<code>MappedAddr1</code> 与本地地址相同；</li>
<li>在 Test II 中可以收到响应。</li>
<li>说明无 NAT 或路由器不进行地址转换。</li>
</ul>
</li>
<li><strong>Full Cone NAT</strong><ul>
<li>Test I 中，<code>MappedAddr1</code> ≠ 本地地址，表示存在 NAT；</li>
<li>Test II 中可以收到响应，说明对于外部地址&#x2F;端口的变化并不受限；</li>
<li>进一步测试可能仍会得到相同的 <code>MAPPED-ADDRESS</code>。</li>
</ul>
</li>
<li><strong>Restricted Cone NAT</strong> 或 <strong>Port Restricted Cone NAT</strong><ul>
<li>Test I 中，<code>MappedAddr1</code> ≠ 本地地址；</li>
<li>Test II 中收不到响应；</li>
<li>Test III 中，<code>MappedAddr1</code> &#x3D;&#x3D; <code>MappedAddr2</code>。</li>
<li>说明对于来自外部的地址（或端口）存在一定限制，但对同一外部地址使用相同的映射端口。</li>
</ul>
</li>
<li><strong>Symmetric NAT</strong><ul>
<li>Test I 中，<code>MappedAddr1</code> ≠ 本地地址；</li>
<li>Test II 中收不到响应；</li>
<li>Test III 中，<code>MappedAddr1</code> 与 <code>MappedAddr2</code> 不同。</li>
<li>说明在不同外部目的地址时，客户端会被 NAT 分配不同的映射端口。</li>
</ul>
</li>
</ol>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li><strong>RFC3489 的检测流程</strong>主要是依赖一台可以在“两个地址或端口”上提供 STUN 服务的服务器，通过客户端向这两个地址发送请求并观察响应结果来推断 NAT 类型。</li>
<li><strong>关键属性</strong>包括 <code>MAPPED-ADDRESS</code> 和 <code>CHANGED-ADDRESS</code>，以及 <code>CHANGE-REQUEST</code> 选项，用来探测 NAT 对外部流量的限制程度。</li>
<li><strong>典型的三个测试</strong>（Test I, Test II, Test III）可帮助判断是否有 NAT，以及 NAT 的类型是 Full Cone、Restricted Cone、Port Restricted Cone 还是 Symmetric。</li>
<li><strong>RFC3489 虽已被 RFC5389 取代</strong>，但它所示范的 NAT 探测流程仍然是理解 NAT 行为和 STUN 工作原理的经典参考。</li>
</ul>

        </div>

        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/NAT-STUN/">#NAT STUN</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2024/12/29/2024-12-29-github_ssh%E4%BD%BF%E7%94%A8443%E7%AB%AF%E5%8F%A3/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Github在443端口使用SSH</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;评论</i>
    </div>
    

        
            
    <div class="twikoo-container">
        <script 
                src="//cdn.jsdelivr.net/npm/twikoo@1.6.39/dist/twikoo.all.min.js"
        ></script>
        <div id="twikoo-comment"></div>
        <script >
            function loadTwikoo() {
                twikoo.init({
                    el: '#twikoo-comment',
                    envId: 'https://comment.hanblog.fun',
                    region: '',
                });
            }

            if ('false') {
                const loadTwikooTimeout = setTimeout(() => {
                    loadTwikoo();
                    clearTimeout(loadTwikooTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadTwikoo);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2025&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Han</a>
			<a href="https://beian.miit.gov.cn/" target="_blank">鲁ICP备19036975号</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>







<div class="post-scripts">
    
</div>



</body>
</html>
